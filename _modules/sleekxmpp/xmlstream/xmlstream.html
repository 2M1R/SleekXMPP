

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sleekxmpp.xmlstream.xmlstream &mdash; SleekXMPP</title>
    
    <link rel="stylesheet" href="../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/theme_extras.js"></script>
    <link rel="top" title="SleekXMPP" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="../../../index.html">
          <span>sleekxmpp.xmlstream.xmlstream</span></a></h1>
        <h2 class="heading"><span>1.0 Documentation</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for sleekxmpp.xmlstream.xmlstream</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SleekXMPP: The Sleek XMPP Library</span>
<span class="sd">    Copyright (C) 2010  Nathanael C. Fritz</span>
<span class="sd">    This file is part of SleekXMPP.</span>

<span class="sd">    See the file LICENSE for copying permission.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">socket</span> <span class="kn">as</span> <span class="nn">Socket</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">queue</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">Queue</span> <span class="kn">as</span> <span class="nn">queue</span>

<span class="kn">import</span> <span class="nn">sleekxmpp</span>
<span class="kn">from</span> <span class="nn">sleekxmpp.thirdparty.statemachine</span> <span class="kn">import</span> <span class="n">StateMachine</span>
<span class="kn">from</span> <span class="nn">sleekxmpp.xmlstream</span> <span class="kn">import</span> <span class="n">Scheduler</span><span class="p">,</span> <span class="n">tostring</span>
<span class="kn">from</span> <span class="nn">sleekxmpp.xmlstream.stanzabase</span> <span class="kn">import</span> <span class="n">StanzaBase</span><span class="p">,</span> <span class="n">ET</span>
<span class="kn">from</span> <span class="nn">sleekxmpp.xmlstream.handler</span> <span class="kn">import</span> <span class="n">Waiter</span><span class="p">,</span> <span class="n">XMLCallback</span>
<span class="kn">from</span> <span class="nn">sleekxmpp.xmlstream.matcher</span> <span class="kn">import</span> <span class="n">MatchXMLMask</span>

<span class="c"># In Python 2.x, file socket objects are broken. A patched socket</span>
<span class="c"># wrapper is provided for this case in filesocket.py.</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">sleekxmpp.xmlstream.filesocket</span> <span class="kn">import</span> <span class="n">FileSocket</span><span class="p">,</span> <span class="n">Socket26</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dns.resolver</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">DNSPYTHON</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">DNSPYTHON</span> <span class="o">=</span> <span class="bp">True</span>


<span class="c"># The time in seconds to wait before timing out waiting for response stanzas.</span>
<span class="n">RESPONSE_TIMEOUT</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c"># The time in seconds to wait for events from the event queue, and also the</span>
<span class="c"># time between checks for the process stop signal.</span>
<span class="n">WAIT_TIMEOUT</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c"># The number of threads to use to handle XML stream events. This is not the</span>
<span class="c"># same as the number of custom event handling threads. HANDLER_THREADS must</span>
<span class="c"># be at least 1.</span>
<span class="n">HANDLER_THREADS</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c"># Flag indicating if the SSL library is available for use.</span>
<span class="n">SSL_SUPPORT</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c"># The time in seconds to delay between attempts to resend data</span>
<span class="c"># after an SSL error.</span>
<span class="n">SSL_RETRY_DELAY</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="c"># The maximum number of times to attempt resending data due to</span>
<span class="c"># an SSL error.</span>
<span class="n">SSL_RETRY_MAX</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c"># Maximum time to delay between connection attempts is one hour.</span>
<span class="n">RECONNECT_MAX_DELAY</span> <span class="o">=</span> <span class="mi">600</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="RestartStream"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.RestartStream">[docs]</a><span class="k">class</span> <span class="nc">RestartStream</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception to restart stream processing, including</span>
<span class="sd">    resending the stream header.</span>
<span class="sd">    &quot;&quot;&quot;</span>

</div>
<div class="viewcode-block" id="XMLStream"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream">[docs]</a><span class="k">class</span> <span class="nc">XMLStream</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An XML stream connection manager and event dispatcher.</span>

<span class="sd">    The XMLStream class abstracts away the issues of establishing a</span>
<span class="sd">    connection with a server and sending and receiving XML &quot;stanzas&quot;.</span>
<span class="sd">    A stanza is a complete XML element that is a direct child of a root</span>
<span class="sd">    document element. Two streams are used, one for each communication</span>
<span class="sd">    direction, over the same socket. Once the connection is closed, both</span>
<span class="sd">    streams should be complete and valid XML documents.</span>

<span class="sd">    Three types of events are provided to manage the stream:</span>
<span class="sd">        Stream    -- Triggered based on received stanzas, similar in concept</span>
<span class="sd">                     to events in a SAX XML parser.</span>
<span class="sd">        Custom    -- Triggered manually.</span>
<span class="sd">        Scheduled -- Triggered based on time delays.</span>

<span class="sd">    Typically, stanzas are first processed by a stream event handler which</span>
<span class="sd">    will then trigger custom events to continue further processing,</span>
<span class="sd">    especially since custom event handlers may run in individual threads.</span>


<span class="sd">    Attributes:</span>
<span class="sd">        address       -- The hostname and port of the server.</span>
<span class="sd">        default_ns    -- The default XML namespace that will be applied</span>
<span class="sd">                         to all non-namespaced stanzas.</span>
<span class="sd">        event_queue   -- A queue of stream, custom, and scheduled</span>
<span class="sd">                         events to be processed.</span>
<span class="sd">        filesocket    -- A filesocket created from the main connection socket.</span>
<span class="sd">                         Required for ElementTree.iterparse.</span>
<span class="sd">        default_port  -- Default port to connect to.</span>
<span class="sd">        namespace_map -- Optional mapping of namespaces to namespace prefixes.</span>
<span class="sd">        scheduler     -- A scheduler object for triggering events</span>
<span class="sd">                         after a given period of time.</span>
<span class="sd">        send_queue    -- A queue of stanzas to be sent on the stream.</span>
<span class="sd">        socket        -- The connection to the server.</span>
<span class="sd">        ssl_support   -- Indicates if a SSL library is available for use.</span>
<span class="sd">        ssl_version   -- The version of the SSL protocol to use.</span>
<span class="sd">                         Defaults to ssl.PROTOCOL_TLSv1.</span>
<span class="sd">        ca_certs      -- File path to a CA certificate to verify the</span>
<span class="sd">                         server&#39;s identity.</span>
<span class="sd">        state         -- A state machine for managing the stream&#39;s</span>
<span class="sd">                         connection state.</span>
<span class="sd">        stream_footer -- The start tag and any attributes for the stream&#39;s</span>
<span class="sd">                         root element.</span>
<span class="sd">        stream_header -- The closing tag of the stream&#39;s root element.</span>
<span class="sd">        use_ssl       -- Flag indicating if SSL should be used.</span>
<span class="sd">        use_tls       -- Flag indicating if TLS should be used.</span>
<span class="sd">        use_proxy     -- Flag indicating that an HTTP Proxy should be used.</span>
<span class="sd">        stop          -- threading Event used to stop all threads.</span>
<span class="sd">        proxy_config  -- An optional dictionary with the following entries:</span>
<span class="sd">                            host     -- The host offering proxy services.</span>
<span class="sd">                            port     -- The port for the proxy service.</span>
<span class="sd">                            username -- Optional username for the proxy.</span>
<span class="sd">                            password -- Optional password for the proxy.</span>

<span class="sd">        auto_reconnect      -- Flag to determine whether we auto reconnect.</span>
<span class="sd">        reconnect_max_delay -- Maximum time to delay between connection</span>
<span class="sd">                               attempts. Defaults to RECONNECT_MAX_DELAY,</span>
<span class="sd">                               which is one hour.</span>
<span class="sd">        dns_answers     -- List of dns answers not yet used to connect.</span>

<span class="sd">    Methods:</span>
<span class="sd">        add_event_handler    -- Add a handler for a custom event.</span>
<span class="sd">        add_handler          -- Shortcut method for registerHandler.</span>
<span class="sd">        connect              -- Connect to the given server.</span>
<span class="sd">        del_event_handler    -- Remove a handler for a custom event.</span>
<span class="sd">        disconnect           -- Disconnect from the server and terminate</span>
<span class="sd">                                processing.</span>
<span class="sd">        event                -- Trigger a custom event.</span>
<span class="sd">        get_id               -- Return the current stream ID.</span>
<span class="sd">        incoming_filter      -- Optionally filter stanzas before processing.</span>
<span class="sd">        new_id               -- Generate a new, unique ID value.</span>
<span class="sd">        process              -- Read XML stanzas from the stream and apply</span>
<span class="sd">                                matching stream handlers.</span>
<span class="sd">        reconnect            -- Reestablish a connection to the server.</span>
<span class="sd">        register_handler     -- Add a handler for a stream event.</span>
<span class="sd">        register_stanza      -- Add a new stanza object type that may appear</span>
<span class="sd">                                as a direct child of the stream&#39;s root.</span>
<span class="sd">        remove_handler       -- Remove a stream handler.</span>
<span class="sd">        remove_stanza        -- Remove a stanza object type.</span>
<span class="sd">        schedule             -- Schedule an event handler to execute after a</span>
<span class="sd">                                given delay.</span>
<span class="sd">        send                 -- Send a stanza object on the stream.</span>
<span class="sd">        send_raw             -- Send a raw string on the stream.</span>
<span class="sd">        send_xml             -- Send an XML string on the stream.</span>
<span class="sd">        set_socket           -- Set the stream&#39;s socket and generate a new</span>
<span class="sd">                                filesocket.</span>
<span class="sd">        start_stream_handler -- Perform any stream initialization such</span>
<span class="sd">                                as handshakes.</span>
<span class="sd">        start_tls            -- Establish a TLS connection and restart</span>
<span class="sd">                                the stream.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Establish a new XML stream.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            socket -- Use an existing socket for the stream.</span>
<span class="sd">                      Defaults to None to generate a new socket.</span>
<span class="sd">            host   -- The name of the target server.</span>
<span class="sd">                      Defaults to the empty string.</span>
<span class="sd">            port   -- The port to use for the connection.</span>
<span class="sd">                      Defaults to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_support</span> <span class="o">=</span> <span class="n">SSL_SUPPORT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_version</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">PROTOCOL_TLSv1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span> <span class="o">=</span> <span class="n">WAIT_TIMEOUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_timeout</span> <span class="o">=</span> <span class="n">RESPONSE_TIMEOUT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_delay</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_max_delay</span> <span class="o">=</span> <span class="n">RECONNECT_MAX_DELAY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_retry_max</span> <span class="o">=</span> <span class="n">SSL_RETRY_MAX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssl_retry_delay</span> <span class="o">=</span> <span class="n">SSL_RETRY_DELAY</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">StateMachine</span><span class="p">((</span><span class="s">&#39;disconnected&#39;</span><span class="p">,</span> <span class="s">&#39;connected&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_set_state</span><span class="p">(</span><span class="s">&#39;disconnected&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_domain</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filesocket</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket_class</span> <span class="o">=</span> <span class="n">Socket26</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket_class</span> <span class="o">=</span> <span class="n">Socket</span><span class="o">.</span><span class="n">socket</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_tls</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_proxy</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">default_ns</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_ns</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_header</span> <span class="o">=</span> <span class="s">&quot;&lt;stream&gt;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_footer</span> <span class="o">=</span> <span class="s">&quot;&lt;/stream&gt;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">whitespace_keepalive</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">whitespace_keepalive_interval</span> <span class="o">=</span> <span class="mi">300</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_end_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_end_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_started_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span> <span class="o">=</span> <span class="mi">45</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">event_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__failed_send_stanza</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span> <span class="o">=</span> <span class="n">Scheduler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">namespace_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">StanzaBase</span><span class="o">.</span><span class="n">xml_ns</span><span class="p">:</span> <span class="s">&#39;xml&#39;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__root_stanza</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dns_answers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="s">&#39;connected&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_connected</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="s">&#39;session_start&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_keepalive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_event_handler</span><span class="p">(</span><span class="s">&#39;session_end&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_keepalive</span><span class="p">)</span>

<div class="viewcode-block" id="XMLStream.use_signals"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.use_signals">[docs]</a>    <span class="k">def</span> <span class="nf">use_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signals</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register signal handlers for SIGHUP and SIGTERM, if possible,</span>
<span class="sd">        which will raise a &quot;killed&quot; event when the application is</span>
<span class="sd">        terminated.</span>

<span class="sd">        If a signal handler already existed, it will be executed first,</span>
<span class="sd">        before the &quot;killed&quot; event is raised.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            signals -- A list of signal names to be monitored.</span>
<span class="sd">                       Defaults to [&#39;SIGHUP&#39;, &#39;SIGTERM&#39;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">signals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">signals</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;SIGHUP&#39;</span><span class="p">,</span> <span class="s">&#39;SIGTERM&#39;</span><span class="p">]</span>

        <span class="n">existing_handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">sig_name</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sig_name</span><span class="p">):</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sig_name</span><span class="p">)</span>
                <span class="n">handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
                    <span class="n">existing_handlers</span><span class="p">[</span><span class="n">sig</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>

        <span class="k">def</span> <span class="nf">handle_kill</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Capture kill event and disconnect cleanly after first</span>
<span class="sd">            spawning the &quot;killed&quot; event.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">signum</span> <span class="ow">in</span> <span class="n">existing_handlers</span> <span class="ow">and</span> \
                   <span class="n">existing_handlers</span><span class="p">[</span><span class="n">signum</span><span class="p">]</span> <span class="o">!=</span> <span class="n">handle_kill</span><span class="p">:</span>
                <span class="n">existing_handlers</span><span class="p">[</span><span class="n">signum</span><span class="p">](</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&quot;killed&quot;</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">sig_name</span> <span class="ow">in</span> <span class="n">signals</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sig_name</span><span class="p">):</span>
                    <span class="n">sig</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">sig_name</span><span class="p">)</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">handle_kill</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__signals_installed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Can not set interrupt signal handlers. &quot;</span> <span class="o">+</span> \
                      <span class="s">&quot;SleekXMPP is not running from a main thread.&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="XMLStream.new_id"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.new_id">[docs]</a>    <span class="k">def</span> <span class="nf">new_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate and return a new stream ID in hexadecimal form.</span>

<span class="sd">        Many stanzas, handlers, or matchers may require unique</span>
<span class="sd">        ID values. Using this method ensures that all new ID values</span>
<span class="sd">        are unique in this stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="XMLStream.get_id"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.get_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the current unique stream ID in hexadecimal form.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%X</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>
</div>
<div class="viewcode-block" id="XMLStream.connect"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">use_ssl</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                <span class="n">use_tls</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">reattempt</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new socket and connect to the server.</span>

<span class="sd">        Setting reattempt to True will cause connection attempts to be made</span>
<span class="sd">        every second until a successful connection is established.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            host      -- The name of the desired server for the connection.</span>
<span class="sd">            port      -- Port to connect to on the server.</span>
<span class="sd">            use_ssl   -- Flag indicating if SSL should be used.</span>
<span class="sd">            use_tls   -- Flag indicating if TLS should be used.</span>
<span class="sd">            reattempt -- Flag indicating if the socket should reconnect</span>
<span class="sd">                         after disconnections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">and</span> <span class="n">port</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">port</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">Socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="n">Socket</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Respect previous SSL and TLS usage directives.</span>
        <span class="k">if</span> <span class="n">use_ssl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="n">use_ssl</span>
        <span class="k">if</span> <span class="n">use_tls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_tls</span> <span class="o">=</span> <span class="n">use_tls</span>

        <span class="c"># Repeatedly attempt to connect until a successful connection</span>
        <span class="c"># is established.</span>
        <span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="s">&#39;disconnected&#39;</span><span class="p">,</span> <span class="s">&#39;connected&#39;</span><span class="p">,</span>
                                          <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">reattempt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">connected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="s">&#39;disconnected&#39;</span><span class="p">,</span> <span class="s">&#39;connected&#39;</span><span class="p">,</span>
                                              <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">connected</span>
</div>
    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;Session timeout check&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_domain</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pick_dns_answer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default_domain</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_class</span><span class="p">(</span><span class="n">Socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">Socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure_socket</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_delay</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reconnect_delay</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_max_delay</span><span class="p">)</span>
            <span class="n">delay</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">normalvariate</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">delay</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Waiting </span><span class="si">%s</span><span class="s"> seconds before connecting.&#39;</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_proxy</span><span class="p">:</span>
            <span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connect_proxy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">connected</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_delay</span> <span class="o">=</span> <span class="n">delay</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_ssl</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_support</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Socket Wrapped for SSL&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cert_policy</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cert_policy</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>

            <span class="n">ssl_socket</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span>
                                         <span class="n">ca_certs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">,</span>
                                         <span class="n">cert_reqs</span><span class="o">=</span><span class="n">cert_policy</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;socket&#39;</span><span class="p">):</span>
                <span class="c"># We are using a testing socket, so preserve the top</span>
                <span class="c"># layer of wrapping.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ssl_socket</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ssl_socket</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_proxy</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Connecting to </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">set_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="c">#this event is where you should set your application state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&quot;connected&quot;</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_delay</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="n">Socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">serr</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;Could not connect to </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">. Socket Error #</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#39;socket_error&#39;</span><span class="p">,</span> <span class="n">serr</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">serr</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">serr</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reconnect_delay</span> <span class="o">=</span> <span class="n">delay</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_connect_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Attempt to connect using an HTTP Proxy.&quot;&quot;&quot;</span>

        <span class="c"># Extract the proxy address, and optional credentials</span>
        <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;host&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]))</span>
        <span class="n">cred</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;username&#39;</span><span class="p">]</span>
            <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_config</span><span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>

            <span class="n">cred</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">cred</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">cred</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cred</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">cred</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">cred</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">cred</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="c"># Build the HTTP headers for connecting to the XMPP server</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;CONNECT </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s"> HTTP/1.0&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
                   <span class="s">&#39;Host: </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
                   <span class="s">&#39;Proxy-Connection: Keep-Alive&#39;</span><span class="p">,</span>
                   <span class="s">&#39;Pragma: no-cache&#39;</span><span class="p">,</span>
                   <span class="s">&#39;User-Agent: SleekXMPP/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">sleekxmpp</span><span class="o">.</span><span class="n">__version__</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cred</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Proxy-Authorization: Basic </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">cred</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Connecting to proxy: </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_raw</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">while</span> <span class="s">&#39;</span><span class="se">\r\n\r\n</span><span class="s">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">resp</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="n">resp</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;RECV: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>

            <span class="n">lines</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;200&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#39;proxy_error&#39;</span><span class="p">,</span> <span class="n">resp</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Proxy Error: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="c"># Proxy connection established, continue connecting</span>
            <span class="c"># with the XMPP server.</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">except</span> <span class="n">Socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">serr</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;Could not connect to </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">. Socket Error #</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#39;socket_error&#39;</span><span class="p">,</span> <span class="n">serr</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">address</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">serr</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">serr</span><span class="o">.</span><span class="n">strerror</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_handle_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add check to ensure that a session is established within</span>
<span class="sd">        a reasonable amount of time.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_handle_session_timeout</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_started_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Session start has taken more &quot;</span> <span class="o">+</span> \
                          <span class="s">&quot;than </span><span class="si">%d</span><span class="s"> seconds&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">reconnect</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="s">&quot;Session timeout check&quot;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session_timeout</span><span class="p">,</span>
                <span class="n">_handle_session_timeout</span><span class="p">)</span>

<div class="viewcode-block" id="XMLStream.disconnect"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Terminate processing and close the XML streams.</span>

<span class="sd">        Optionally, the connection may be reconnected and</span>
<span class="sd">        resume processing afterwards.</span>

<span class="sd">        If the disconnect should take place after all items</span>
<span class="sd">        in the send queue have been sent, use wait=True. However,</span>
<span class="sd">        take note: If you are constantly adding items to the queue</span>
<span class="sd">        such that it is never empty, then the disconnect will</span>
<span class="sd">        not occur and the call will continue to block.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            reconnect -- Flag indicating if the connection</span>
<span class="sd">                         and processing should be restarted.</span>
<span class="sd">                         Defaults to False.</span>
<span class="sd">            wait      -- Flag indicating if the send queue should</span>
<span class="sd">                         be emptied before disconnecting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="s">&#39;connected&#39;</span><span class="p">,</span> <span class="s">&#39;disconnected&#39;</span><span class="p">,</span>
                              <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">reconnect</span><span class="p">,</span> <span class="n">wait</span><span class="p">))</span>
</div>
    <span class="k">def</span> <span class="nf">_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c"># Wait for the send queue to empty.</span>
        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c"># Send the end of stream marker.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_raw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream_footer</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session_started_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c"># Wait for confirmation that the stream was</span>
        <span class="c"># closed in the other direction.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span> <span class="o">=</span> <span class="n">reconnect</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Waiting for </span><span class="si">%s</span><span class="s"> from server&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_footer</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream_end_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">Socket</span><span class="o">.</span><span class="n">SHUT_RDWR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filesocket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">serr</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#39;socket_error&#39;</span><span class="p">,</span> <span class="n">serr</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c">#clear your application state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#39;session_end&#39;</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&quot;disconnected&quot;</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="XMLStream.reconnect"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.reconnect">[docs]</a>    <span class="k">def</span> <span class="nf">reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reattempt</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the stream&#39;s state and reconnect to the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;reconnecting...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">ensure</span><span class="p">(</span><span class="s">&#39;connected&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="s">&#39;connected&#39;</span><span class="p">,</span> <span class="s">&#39;disconnected&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                                  <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_disconnect</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">True</span><span class="p">,))</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;connecting...&quot;</span><span class="p">)</span>
        <span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="s">&#39;disconnected&#39;</span><span class="p">,</span> <span class="s">&#39;connected&#39;</span><span class="p">,</span>
                                          <span class="n">wait</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">reattempt</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">connected</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="n">connected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">transition</span><span class="p">(</span><span class="s">&#39;disconnected&#39;</span><span class="p">,</span> <span class="s">&#39;connected&#39;</span><span class="p">,</span>
                                              <span class="n">wait</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_connect</span><span class="p">)</span>
            <span class="n">connected</span> <span class="o">=</span> <span class="n">connected</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">ensure</span><span class="p">(</span><span class="s">&#39;connected&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">connected</span>
</div>
<div class="viewcode-block" id="XMLStream.set_socket"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.set_socket">[docs]</a>    <span class="k">def</span> <span class="nf">set_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the socket to use for the stream.</span>

<span class="sd">        The filesocket will be recreated as well.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            socket -- The new socket to use.</span>
<span class="sd">            ignore -- don&#39;t set the state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span>
        <span class="k">if</span> <span class="n">socket</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># ElementTree.iterparse requires a file.</span>
            <span class="c"># 0 buffer files have to be binary.</span>

            <span class="c"># Use the correct fileobject type based on the Python</span>
            <span class="c"># version to work around a broken implementation in</span>
            <span class="c"># Python 2.x.</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filesocket</span> <span class="o">=</span> <span class="n">FileSocket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">filesocket</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s">&#39;rb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">_set_state</span><span class="p">(</span><span class="s">&#39;connected&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="XMLStream.configure_socket"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.configure_socket">[docs]</a>    <span class="k">def</span> <span class="nf">configure_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set timeout and other options for self.socket.</span>

<span class="sd">        Meant to be overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="XMLStream.configure_dns"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.configure_dns">[docs]</a>    <span class="k">def</span> <span class="nf">configure_dns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resolver</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure and set options for a dns.resolver.Resolver</span>
<span class="sd">        instance, and other DNS related tasks. For example, you</span>
<span class="sd">        can also check Socket.getaddrinfo to see if you need to</span>
<span class="sd">        call out to libresolv.so.2 to run res_init().</span>

<span class="sd">        Meant to be overridden.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            resolver -- A dns.resolver.Resolver instance, or None</span>
<span class="sd">                        if dnspython is not installed.</span>
<span class="sd">            domain   -- The initial domain under consideration.</span>
<span class="sd">            port     -- The initial port under consideration.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="XMLStream.start_tls"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.start_tls">[docs]</a>    <span class="k">def</span> <span class="nf">start_tls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform handshakes for TLS.</span>

<span class="sd">        If the handshake is successful, the XML stream will need</span>
<span class="sd">        to be restarted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_support</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Negotiating TLS&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Using SSL version: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_version</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cert_policy</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_NONE</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cert_policy</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>

            <span class="n">ssl_socket</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span>
                                         <span class="n">ssl_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_version</span><span class="p">,</span>
                                         <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                         <span class="n">ca_certs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">,</span>
                                         <span class="n">cert_reqs</span><span class="o">=</span><span class="n">cert_policy</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="s">&#39;socket&#39;</span><span class="p">):</span>
                <span class="c"># We are using a testing socket, so preserve the top</span>
                <span class="c"># layer of wrapping.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ssl_socket</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ssl_socket</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">do_handshake</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Tried to enable TLS, but ssl module not found.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
    <span class="k">def</span> <span class="nf">_start_keepalive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Begin sending whitespace periodically to keep the connection alive.</span>

<span class="sd">        May be disabled by setting:</span>
<span class="sd">            self.whitespace_keepalive = False</span>

<span class="sd">        The keepalive interval can be set using:</span>
<span class="sd">            self.whitespace_keepalive_interval = 300</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">send_keepalive</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">send_raw</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="s">&#39;Whitespace Keepalive&#39;</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">whitespace_keepalive_interval</span><span class="p">,</span>
                      <span class="n">send_keepalive</span><span class="p">,</span>
                      <span class="n">repeat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_end_keepalive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stop sending whitespace keepalives&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&#39;Whitespace Keepalive&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="XMLStream.start_stream_handler"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.start_stream_handler">[docs]</a>    <span class="k">def</span> <span class="nf">start_stream_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform any initialization actions, such as handshakes, once the</span>
<span class="sd">        stream header has been sent.</span>

<span class="sd">        Meant to be overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="XMLStream.register_stanza"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.register_stanza">[docs]</a>    <span class="k">def</span> <span class="nf">register_stanza</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stanza_class</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a stanza object class as a known root stanza. A root stanza is</span>
<span class="sd">        one that appears as a direct child of the stream&#39;s root element.</span>

<span class="sd">        Stanzas that appear as substanzas of a root stanza do not need to</span>
<span class="sd">        be registered here. That is done using register_stanza_plugin() from</span>
<span class="sd">        sleekxmpp.xmlstream.stanzabase.</span>

<span class="sd">        Stanzas that are not registered will not be converted into</span>
<span class="sd">        stanza objects, but may still be processed using handlers and</span>
<span class="sd">        matchers.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            stanza_class -- The top-level stanza object&#39;s class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__root_stanza</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stanza_class</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="XMLStream.remove_stanza"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.remove_stanza">[docs]</a>    <span class="k">def</span> <span class="nf">remove_stanza</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stanza_class</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a stanza from being a known root stanza. A root stanza is</span>
<span class="sd">        one that appears as a direct child of the stream&#39;s root element.</span>

<span class="sd">        Stanzas that are not registered will not be converted into</span>
<span class="sd">        stanza objects, but may still be processed using handlers and</span>
<span class="sd">        matchers.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root_stanza</span><span class="p">[</span><span class="n">stanza_class</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="XMLStream.add_handler"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.add_handler">[docs]</a>    <span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pointer</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">disposable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">threaded</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">instream</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A shortcut method for registering a handler using XML masks.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            mask       -- An XML snippet matching the structure of the</span>
<span class="sd">                          stanzas that will be passed to this handler.</span>
<span class="sd">            pointer    -- The handler function itself.</span>
<span class="sd">            name       -- A unique name for the handler. A name will</span>
<span class="sd">                          be generated if one is not provided.</span>
<span class="sd">            disposable -- Indicates if the handler should be discarded</span>
<span class="sd">                          after one use.</span>
<span class="sd">            threaded   -- Deprecated. Remains for backwards compatibility.</span>
<span class="sd">            filter     -- Deprecated. Remains for backwards compatibility.</span>
<span class="sd">            instream   -- Indicates if the handler should execute during</span>
<span class="sd">                          stream processing and not during normal event</span>
<span class="sd">                          processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># To prevent circular dependencies, we must load the matcher</span>
        <span class="c"># and handler classes here.</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;add_handler_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">getNewId</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registerHandler</span><span class="p">(</span><span class="n">XMLCallback</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">MatchXMLMask</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">pointer</span><span class="p">,</span>
                                         <span class="n">once</span><span class="o">=</span><span class="n">disposable</span><span class="p">,</span> <span class="n">instream</span><span class="o">=</span><span class="n">instream</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="XMLStream.register_handler"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.register_handler">[docs]</a>    <span class="k">def</span> <span class="nf">register_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">before</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a stream event handler that will be executed when a matching</span>
<span class="sd">        stanza is received.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            handler -- The handler object to execute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">stream</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="XMLStream.remove_handler"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.remove_handler">[docs]</a>    <span class="k">def</span> <span class="nf">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove any stream event handlers with the given name.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name -- The name of the handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__handlers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="XMLStream.get_dns_records"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.get_dns_records">[docs]</a>    <span class="k">def</span> <span class="nf">get_dns_records</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the DNS records for a domain.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            domain -- The domain in question.</span>
<span class="sd">            port   -- If the results don&#39;t include a port, use this one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_port</span>
        <span class="k">if</span> <span class="n">DNSPYTHON</span><span class="p">:</span>
            <span class="n">resolver</span> <span class="o">=</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">get_default_resolver</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configure_dns</span><span class="p">(</span><span class="n">resolver</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">answers</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">dns</span><span class="o">.</span><span class="n">rdatatype</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NXDOMAIN</span><span class="p">,</span> <span class="n">dns</span><span class="o">.</span><span class="n">resolver</span><span class="o">.</span><span class="n">NoAnswer</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;No A records for </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[((</span><span class="n">domain</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="k">except</span> <span class="n">dns</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;DNS resolution timed out &quot;</span> <span class="o">+</span> \
                            <span class="s">&quot;for A record of </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[((</span><span class="n">domain</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[((</span><span class="n">ans</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">ans</span> <span class="ow">in</span> <span class="n">answers</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;dnspython is not installed -- &quot;</span> <span class="o">+</span> \
                        <span class="s">&quot;relying on OS A record resolution&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">configure_dns</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">domain</span><span class="o">=</span><span class="n">domain</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[((</span><span class="n">domain</span><span class="p">,</span> <span class="n">port</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
</div>
<div class="viewcode-block" id="XMLStream.pick_dns_answer"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.pick_dns_answer">[docs]</a>    <span class="k">def</span> <span class="nf">pick_dns_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pick a server and port from DNS answers.</span>
<span class="sd">        Gets DNS answers if none available.</span>
<span class="sd">        Removes used answer from available answers.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            domain -- The domain in question.</span>
<span class="sd">            port   -- If the results don&#39;t include a port, use this one.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_answers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dns_answers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_dns_records</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="n">addresses</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">intmax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">topprio</span> <span class="o">=</span> <span class="mi">65535</span>
        <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_answers</span><span class="p">:</span>
            <span class="n">topprio</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">topprio</span><span class="p">,</span> <span class="n">answer</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">answer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_answers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">answer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">topprio</span><span class="p">:</span>
                <span class="n">intmax</span> <span class="o">+=</span> <span class="n">answer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">addresses</span><span class="p">[</span><span class="n">intmax</span><span class="p">]</span> <span class="o">=</span> <span class="n">answer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c">#python3 returns a generator for dictionary keys</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">addresses</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="n">items</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="n">picked</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">intmax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">picked</span> <span class="o">&lt;=</span> <span class="n">item</span><span class="p">:</span>
                <span class="n">address</span> <span class="o">=</span> <span class="n">addresses</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
                <span class="k">break</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">answer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dns_answers</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dns_answers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">address</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dns_answers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Trying to connect to </span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">address</span>
</div>
<div class="viewcode-block" id="XMLStream.add_event_handler"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.add_event_handler">[docs]</a>    <span class="k">def</span> <span class="nf">add_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pointer</span><span class="p">,</span>
                          <span class="n">threaded</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">disposable</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a custom event handler that will be executed whenever</span>
<span class="sd">        its event is manually triggered.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name       -- The name of the event that will trigger</span>
<span class="sd">                          this handler.</span>
<span class="sd">            pointer    -- The function to execute.</span>
<span class="sd">            threaded   -- If set to True, the handler will execute</span>
<span class="sd">                          in its own thread. Defaults to False.</span>
<span class="sd">            disposable -- If set to True, the handler will be</span>
<span class="sd">                          discarded after one use. Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">pointer</span><span class="p">,</span> <span class="n">threaded</span><span class="p">,</span> <span class="n">disposable</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="XMLStream.del_event_handler"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.del_event_handler">[docs]</a>    <span class="k">def</span> <span class="nf">del_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">pointer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a function as a handler for an event.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name    -- The name of the event.</span>
<span class="sd">            pointer -- The function to remove as a handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># Need to keep handlers that do not use</span>
        <span class="c"># the given function pointer</span>
        <span class="k">def</span> <span class="nf">filter_pointers</span><span class="p">(</span><span class="n">handler</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pointer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span>
            <span class="n">filter_pointers</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
</div>
<div class="viewcode-block" id="XMLStream.event_handled"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.event_handled">[docs]</a>    <span class="k">def</span> <span class="nf">event_handled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Indicates if an event has any associated handlers.</span>

<span class="sd">        Returns the number of registered handlers.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name -- The name of the event to check.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[]))</span>
</div>
<div class="viewcode-block" id="XMLStream.event"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.event">[docs]</a>    <span class="k">def</span> <span class="nf">event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">direct</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually trigger a custom event.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name     -- The name of the event to trigger.</span>
<span class="sd">            data     -- Data that will be passed to each event handler.</span>
<span class="sd">                        Defaults to an empty dictionary.</span>
<span class="sd">            direct   -- Runs the event directly if True, skipping the</span>
<span class="sd">                        event queue. All event handlers will run in the</span>
<span class="sd">                        same thread.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
            <span class="c">#TODO:  Data should not be copied, but should be read only,</span>
            <span class="c">#       but this might break current code so it&#39;s left for future.</span>

            <span class="n">out_data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">data</span>
            <span class="n">old_exception</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;exception&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">direct</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">out_data</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;Error processing event handler: </span><span class="si">%s</span><span class="s">&#39;</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span>  <span class="nb">str</span><span class="p">(</span><span class="n">handler</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">old_exception</span><span class="p">:</span>
                        <span class="n">old_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s">&#39;event&#39;</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">out_data</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">handler</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="c"># If the handler is disposable, we will go ahead and</span>
                <span class="c"># remove it now instead of waiting for it to be</span>
                <span class="c"># processed in the queue.</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers_lock</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">h_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__event_handlers</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">h_index</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="XMLStream.schedule"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.schedule">[docs]</a>    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">kwargs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule a callback function to execute after a given delay.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            name     -- A unique name for the scheduled callback.</span>
<span class="sd">            seconds  -- The time in seconds to wait before executing.</span>
<span class="sd">            callback -- A pointer to the function to execute.</span>
<span class="sd">            args     -- A tuple of arguments to pass to the function.</span>
<span class="sd">            kwargs   -- A dictionary of keyword arguments to pass to</span>
<span class="sd">                        the function.</span>
<span class="sd">            repeat   -- Flag indicating if the scheduled event should</span>
<span class="sd">                        be reset and repeat after executing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span>
                           <span class="n">repeat</span><span class="p">,</span> <span class="n">qpointer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">event_queue</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="XMLStream.incoming_filter"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.incoming_filter">[docs]</a>    <span class="k">def</span> <span class="nf">incoming_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Filter incoming XML objects before they are processed.</span>

<span class="sd">        Possible uses include remapping namespaces, or correcting elements</span>
<span class="sd">        from sources with incorrect behavior.</span>

<span class="sd">        Meant to be overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">xml</span>
</div>
<div class="viewcode-block" id="XMLStream.send"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.send">[docs]</a>    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A wrapper for send_raw for sending stanza objects.</span>

<span class="sd">        May optionally block until an expected response is received.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            data    -- The stanza object to send on the stream.</span>
<span class="sd">            mask    -- Deprecated. An XML snippet matching the structure</span>
<span class="sd">                       of the expected response. Execution will block</span>
<span class="sd">                       in this thread until the response is received</span>
<span class="sd">                       or a timeout occurs.</span>
<span class="sd">            timeout -- Time in seconds to wait for a response before</span>
<span class="sd">                       continuing. Defaults to RESPONSE_TIMEOUT.</span>
<span class="sd">            now     -- Indicates if the send queue should be skipped,</span>
<span class="sd">                       sending the stanza immediately. Useful mainly</span>
<span class="sd">                       for stream initialization stanzas.</span>
<span class="sd">                       Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_timeout</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="s">&#39;xml&#39;</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">xml</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Use of send mask waiters is deprecated.&quot;</span><span class="p">)</span>
            <span class="n">wait_for</span> <span class="o">=</span> <span class="n">Waiter</span><span class="p">(</span><span class="s">&quot;SendWait_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_id</span><span class="p">(),</span>
                              <span class="n">MatchXMLMask</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register_handler</span><span class="p">(</span><span class="n">wait_for</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_raw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">wait_for</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="XMLStream.send_xml"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.send_xml">[docs]</a>    <span class="k">def</span> <span class="nf">send_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send an XML object on the stream, and optionally wait</span>
<span class="sd">        for a response.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            data    -- The XML object to send on the stream.</span>
<span class="sd">            mask    -- Deprecated. An XML snippet matching the structure</span>
<span class="sd">                       of the expected response. Execution will block</span>
<span class="sd">                       in this thread until the response is received</span>
<span class="sd">                       or a timeout occurs.</span>
<span class="sd">            timeout -- Time in seconds to wait for a response before</span>
<span class="sd">                       continuing. Defaults to RESPONSE_TIMEOUT.</span>
<span class="sd">            now     -- Indicates if the send queue should be skipped,</span>
<span class="sd">                       sending the stanza immediately. Useful mainly</span>
<span class="sd">                       for stream initialization stanzas.</span>
<span class="sd">                       Defaults to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_timeout</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">tostring</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">mask</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="XMLStream.send_raw"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.send_raw">[docs]</a>    <span class="k">def</span> <span class="nf">send_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send raw data across the stream.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            data      -- Any string value.</span>
<span class="sd">            reconnect -- Indicates if the stream should be</span>
<span class="sd">                         restarted if there is an error sending</span>
<span class="sd">                         the stanza. Used mainly for testing.</span>
<span class="sd">                         Defaults to self.auto_reconnect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">now</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;SEND (IMMED): </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">sent</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sent</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">sent</span><span class="p">:])</span>
                        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span> <span class="k">as</span> <span class="n">serr</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">tries</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_retry_max</span><span class="p">:</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;SSL error - max retries reached&#39;</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">serr</span><span class="p">)</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Failed to send </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">reconnect</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="n">reconnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">reconnect</span><span class="p">)</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;SSL write error - reattempting&#39;</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_retry_delay</span><span class="p">)</span>
                        <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;SENT: </span><span class="si">%d</span><span class="s"> chunks&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">serr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#39;socket_error&#39;</span><span class="p">,</span> <span class="n">serr</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Failed to send </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">reconnect</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">reconnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">reconnect</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="XMLStream.process"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the XML streams and begin processing events.</span>

<span class="sd">        The number of threads used for processing stream events is determined</span>
<span class="sd">        by HANDLER_THREADS.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            block -- If block=False then event dispatcher will run</span>
<span class="sd">                     in a separate thread, allowing for the stream to be</span>
<span class="sd">                     used in the background for another application.</span>
<span class="sd">                     Otherwise, process(block=True) blocks the current thread.</span>
<span class="sd">                     Defaults to False.</span>

<span class="sd">            **threaded is deprecated and included for API compatibility**</span>
<span class="sd">            threaded -- If threaded=True then event dispatcher will run</span>
<span class="sd">                        in a separate thread, allowing for the stream to be</span>
<span class="sd">                        used in the background for another application.</span>
<span class="sd">                        Defaults to True.</span>

<span class="sd">            Event handlers and the send queue will be threaded</span>
<span class="sd">            regardless of these parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&#39;threaded&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="s">&#39;block&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;process() called with both &quot;</span> <span class="o">+</span> \
                             <span class="s">&quot;block and threaded arguments&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s">&#39;block&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">threaded</span> <span class="o">=</span> <span class="ow">not</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;block&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threaded</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;threaded&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">threaded</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">start_thread</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thread</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">HANDLER_THREADS</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Starting HANDLER THREAD&quot;</span><span class="p">)</span>
            <span class="n">start_thread</span><span class="p">(</span><span class="s">&#39;stream_event_handler_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_runner</span><span class="p">)</span>

        <span class="n">start_thread</span><span class="p">(</span><span class="s">&#39;send_thread&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_thread</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">threaded</span><span class="p">:</span>
            <span class="c"># Run the XML stream in the background for another application.</span>
            <span class="n">start_thread</span><span class="p">(</span><span class="s">&#39;process&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start processing the XML streams.</span>

<span class="sd">        Processing will continue after any recoverable errors</span>
<span class="sd">        if reconnections are allowed.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># The body of this loop will only execute once per connection.</span>
        <span class="c"># Additional passes will be made only if an error occurs and</span>
        <span class="c"># reconnecting is permitted.</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c"># The call to self.__read_xml will block and prevent</span>
                <span class="c"># the body of the loop from running until a disconnect</span>
                <span class="c"># occurs. After any reconnection, the stream header will</span>
                <span class="c"># be resent and processing will resume.</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="c"># Only process the stream while connected to the server</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">ensure</span><span class="p">(</span><span class="s">&#39;connected&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                             <span class="n">block_on_transition</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="c"># Ensure the stream header is sent for any</span>
                    <span class="c"># new connections.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_started_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">send_raw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stream_header</span><span class="p">,</span> <span class="n">now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__read_xml</span><span class="p">():</span>
                        <span class="c"># If the server terminated the stream, end processing</span>
                        <span class="k">break</span>
            <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error reading from XML stream.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Keyboard Escape Detected in _process&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;SystemExit in _process&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scheduler</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">Socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">serr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#39;socket_error&#39;</span><span class="p">,</span> <span class="n">serr</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Socket Error&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Connection error.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">()</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">__read_xml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the incoming XML stream, raising stream events for</span>
<span class="sd">        each received stanza.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">xml</span> <span class="ow">in</span> <span class="n">ET</span><span class="o">.</span><span class="n">iterparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filesocket</span><span class="p">,</span> <span class="p">(</span><span class="n">b</span><span class="s">&#39;end&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;start&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;start&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c"># We have received the start of the root element.</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">xml</span>
                    <span class="c"># Perform any stream initialization actions, such</span>
                    <span class="c"># as handshakes.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stream_end_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">start_stream_handler</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
                <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="n">b</span><span class="s">&#39;end&#39;</span><span class="p">:</span>
                <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c"># The stream&#39;s root element has closed,</span>
                    <span class="c"># terminating the stream.</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;End of stream recieved&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stream_end_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">False</span>
                <span class="k">elif</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c"># We only raise events for stanzas that are direct</span>
                    <span class="c"># children of the root element.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__spawn_event</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">RestartStream</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="n">root</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="c"># Keep the root element empty of children to</span>
                        <span class="c"># save on memory use.</span>
                        <span class="n">root</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Ending read XML loop&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_stanza</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">,</span> <span class="n">default_ns</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a stanza object from a given XML object.</span>

<span class="sd">        If a specialized stanza type is not found for the XML, then</span>
<span class="sd">        a generic StanzaBase stanza will be returned.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            xml        -- The XML object to convert into a stanza object.</span>
<span class="sd">            default_ns -- Optional default namespace to use instead of the</span>
<span class="sd">                          stream&#39;s current default namespace.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">default_ns</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">default_ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_ns</span>
        <span class="n">stanza_type</span> <span class="o">=</span> <span class="n">StanzaBase</span>
        <span class="k">for</span> <span class="n">stanza_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__root_stanza</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xml</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;{</span><span class="si">%s</span><span class="s">}</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">default_ns</span><span class="p">,</span> <span class="n">stanza_class</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="n">xml</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="n">stanza_class</span><span class="o">.</span><span class="n">tag_name</span><span class="p">():</span>
                <span class="n">stanza_type</span> <span class="o">=</span> <span class="n">stanza_class</span>
                <span class="k">break</span>
        <span class="n">stanza</span> <span class="o">=</span> <span class="n">stanza_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stanza</span>

    <span class="k">def</span> <span class="nf">__spawn_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze incoming XML stanzas and convert them into stanza</span>
<span class="sd">        objects if applicable and queue stream events to be processed</span>
<span class="sd">        by matching handlers.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            xml -- The XML stanza to analyze.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;RECV: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tostring</span><span class="p">(</span><span class="n">xml</span><span class="p">,</span> <span class="n">xmlns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_ns</span><span class="p">,</span>
                                            <span class="n">stream</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
        <span class="c"># Apply any preprocessing filters.</span>
        <span class="n">xml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">incoming_filter</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

        <span class="c"># Convert the raw XML object into a stanza object. If no registered</span>
        <span class="c"># stanza type applies, a generic StanzaBase stanza will be used.</span>
        <span class="n">stanza</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_stanza</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>

        <span class="c"># Match the stanza against registered handlers. Handlers marked</span>
        <span class="c"># to run &quot;in stream&quot; will be executed immediately; the rest will</span>
        <span class="c"># be queued.</span>
        <span class="n">unhandled</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">matched_handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__handlers</span> <span class="k">if</span> <span class="n">h</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">stanza</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">matched_handlers</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_handlers</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">stanza_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">stanza</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stanza_copy</span> <span class="o">=</span> <span class="n">stanza</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">prerun</span><span class="p">(</span><span class="n">stanza_copy</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s">&#39;stanza&#39;</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">stanza_copy</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">check_delete</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__handlers</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c"># not thread safe</span>
            <span class="n">unhandled</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Some stanzas require responses, such as Iq queries. A default</span>
        <span class="c"># handler will be executed immediately for this case.</span>
        <span class="k">if</span> <span class="n">unhandled</span><span class="p">:</span>
            <span class="n">stanza</span><span class="o">.</span><span class="n">unhandled</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_threaded_event_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Capture exceptions for event handlers that run</span>
<span class="sd">        in individual threads.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            func -- The event handler to execute.</span>
<span class="sd">            args -- Arguments to the event handler.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># this is always already copied before this is invoked</span>
        <span class="n">orig</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;Error processing event handler: </span><span class="si">%s</span><span class="s">&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="s">&#39;exception&#39;</span><span class="p">):</span>
                <span class="n">orig</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_event_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the event queue and execute handlers.</span>

<span class="sd">        The number of event runner threads is controlled by HANDLER_THREADS.</span>

<span class="sd">        Stream event handlers will all execute in this thread. Custom event</span>
<span class="sd">        handlers may be spawned in individual threads.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Loading event runner&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wait</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_timeout</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                    <span class="n">event</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="n">event</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">etype</span><span class="p">,</span> <span class="n">handler</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                <span class="n">orig</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">etype</span> <span class="o">==</span> <span class="s">&#39;stanza&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">handler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;Error processing stream handler: </span><span class="si">%s</span><span class="s">&#39;</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="n">handler</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">orig</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s">&#39;schedule&#39;</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;Scheduled event: </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">handler</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Error processing scheduled task&#39;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s">&#39;event&#39;</span><span class="p">:</span>
                    <span class="n">func</span><span class="p">,</span> <span class="n">threaded</span><span class="p">,</span> <span class="n">disposable</span> <span class="o">=</span> <span class="n">handler</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">threaded</span><span class="p">:</span>
                            <span class="n">x</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s">&quot;Event_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">func</span><span class="p">),</span>
                                    <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_threaded_event_wrapper</span><span class="p">,</span>
                                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
                            <span class="n">x</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&#39;Error processing event handler: </span><span class="si">%s</span><span class="s">&#39;</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">error_msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">func</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">orig</span><span class="p">,</span> <span class="s">&#39;exception&#39;</span><span class="p">):</span>
                            <span class="n">orig</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">etype</span> <span class="o">==</span> <span class="s">&#39;quit&#39;</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Quitting event runner thread&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Keyboard Escape Detected in _event_runner&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#39;killed&#39;</span><span class="p">,</span> <span class="n">direct</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">SystemExit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="s">&#39;quit&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
            <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_send_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract stanzas from the send queue and send them on the stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span> <span class="ow">and</span> \
                      <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_started_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">session_started_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__failed_send_stanza</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__failed_send_stanza</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__failed_send_stanza</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;SEND: </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                <span class="n">enc_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">enc_data</span><span class="p">)</span>
                <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">sent</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">sent</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">sent</span><span class="p">:])</span>
                            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span> <span class="k">as</span> <span class="n">serr</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">tries</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ssl_retry_max</span><span class="p">:</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;SSL error - max retries reached&#39;</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">serr</span><span class="p">)</span>
                                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Failed to send </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">reconnect</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                                    <span class="n">reconnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">reconnect</span><span class="p">)</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&#39;SSL write error - reattempting&#39;</span><span class="p">)</span>
                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ssl_retry_delay</span><span class="p">)</span>
                            <span class="n">tries</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;SENT: </span><span class="si">%d</span><span class="s"> chunks&#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">send_queue</span><span class="o">.</span><span class="n">task_done</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">Socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">serr</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#39;socket_error&#39;</span><span class="p">,</span> <span class="n">serr</span><span class="p">)</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Failed to send </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__failed_send_stanza</span> <span class="o">=</span> <span class="n">data</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s">&#39;Unexpected error in send thread: </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">auto_reconnect</span><span class="p">)</span>

<div class="viewcode-block" id="XMLStream.exception"><a class="viewcode-back" href="../../../api/xmlstream/xmlstream.html#sleekxmpp.xmlstream.xmlstream.XMLStream.exception">[docs]</a>    <span class="k">def</span> <span class="nf">exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an unknown exception.</span>

<span class="sd">        Meant to be overridden.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            exception -- An unhandled exception object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="c"># To comply with PEP8, method names now use underscores.</span>
<span class="c"># Deprecated method names are re-mapped for backwards compatibility.</span></div></div>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">startTLS</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">start_tls</span>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">registerStanza</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">register_stanza</span>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">removeStanza</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">remove_stanza</span>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">registerHandler</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">register_handler</span>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">removeHandler</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">remove_handler</span>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">setSocket</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">set_socket</span>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">sendRaw</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">send_raw</span>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">getId</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">get_id</span>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">getNewId</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">new_id</span>
<span class="n">XMLStream</span><span class="o">.</span><span class="n">sendXML</span> <span class="o">=</span> <span class="n">XMLStream</span><span class="o">.</span><span class="n">send_xml</span>
</pre></div>

      </div>
      <div class="bottomnav">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <a id="from_andyet" href="http://andyet.net"><h2>From &amp;yet</h2></a>

    <div class="footer">
        &copy; Copyright 2011, Nathan Fritz, Lance Stout.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>